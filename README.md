# EPUB Metadata Extractor

This project extracts rich metadata from EPUB files. It combines basic metadata parsed from the EPUB file and an external publisher data source with in-depth literary analysis generated by Google's Gemini AI. The tool analyzes the full text of a book to determine its genre, themes, setting, narrative tone, and more.

## Features

- Extracts standard metadata like title, author, and publication year.
- Utilizes Google's Gemini Pro model for deep content analysis.
- Identifies complex literary elements:
    - Genre
    - Themes
    - Setting (Time and Place)
    - Cultural Context
    - Narrative Tone
    - Author's Writing Style
    - Main Characters and their Relationships
- Uses `outlines` to ensure the AI-generated data is structured and valid, conforming to Pydantic models.
- Merges metadata from different sources into a single, comprehensive output.
- Uses Apache Tika for robust EPUB content and metadata parsing.

## How It Works

1.  **Publisher Metadata**: The [`read_publisher_metadata`](main.py) function in [`main.py`](main.py) reads known book metadata from `dataset/metadata.csv`.
2.  **EPUB Parsing**: The script uses `tika` to parse the specified EPUB file, extracting its text content and any embedded metadata (like `dc:title`).
3.  **AI Content Analysis**: The extracted text content is sent to the Gemini API via the [`extract_information`](main.py) function. A detailed prompt guides the model to perform a literary analysis.
4.  **Structured Output**: The `outlines` library is used to constrain the AI's output, ensuring it returns a valid JSON object that matches the [`ContentInformation`](nextory/model.py) Pydantic model defined in [`nextory/model.py`](nextory/model.py).
5.  **Data Consolidation**: The script intelligently merges the metadata from the publisher's CSV, the EPUB's internal metadata, and the AI-generated analysis into a final [`BookMetadata`](nextory/model.py) object.
6.  **Output**: The final, consolidated metadata object is printed to the console as a formatted JSON string.

## Setup and Installation

### Prerequisites

- Python 3.12+
- Java (required by Apache Tika)

### Installation

1.  **Clone the repository:**
    ```sh
    git clone <repository-url>
    cd epub-metadata-extractor
    ```

2.  **Create a virtual environment and install dependencies:**
    This project uses `uv` for package management.
    ```sh
    python -m venv .venv
    source .venv/bin/activate
    uv pip install -e .
    ```

3.  **Set up environment variables:**
    Create a `.env` file in the project root and add your Google Gemini API key.
    ````
    // filepath: .env
    GEMINI_API_KEY="YOUR_API_KEY_HERE"
    ````

## Usage

To run the extractor, execute the main script:

```sh
python main.py
```

By default, the script processes the file `./dataset/pg1342.epub` and uses `./dataset/metadata.csv` for publisher information. You can modify the `FILE_NAME` variable in [`main.py`](main.py) to point to a different EPUB file.

### Example Output

The script will print a JSON object to the standard output, similar to this:

```json
{
    "title": "Pride and Prejudice",
    "author": "Jane Austen",
    "publishing_year": 1813,
    "epub_id": "pg1342",
    "genre": "Romance",
    "themes": [
        "Love",
        "Class",
        "Pride",
        "Prejudice",
        "Family"
    ],
    "setting": {
        "time": "Regency era England",
        "place": "Rural England"
    },
    "cultural_context": "The novel is set within the context of the landed gentry in early 19th-century England, where social standing and wealth were paramount.",
    "narrative_tone": "Ironic, witty, and satirical, with a focus on social commentary.",
    "author_writing_style": "Characterized by free indirect discourse, irony, and detailed social observation.",
    "characters_and_relationships": [
        {
            "name": "Elizabeth Bennet",
            "relationship": "Protagonist, develops a complex relationship with Mr. Darcy."
        },
        {
            "name": "Mr. Darcy",
            "relationship": "Initial antagonist, love interest of Elizabeth Bennet."
        }
    ]
}
```

## License

This project is licensed under the MIT License. See the [LICENSE](LICENSE) file for details.
