# EPUB Metadata Extractor

This project extracts rich metadata from EPUB files. It combines basic metadata parsed from the EPUB file and an external publisher data source with in-depth literary analysis generated by Google's Gemini AI. The tool analyzes the full text of a book to determine its genre, themes, setting, narrative tone, and more.

## Features

- Extracts standard metadata like title, author, and publication year.
- Utilizes Google's Gemini Pro model for deep content analysis.
- Identifies complex literary elements:
    - Genre
    - Themes
    - Setting (Time and Place)
    - Cultural Context
    - Narrative Tone
    - Author's Writing Style
    - Main Characters and their Relationships
- Uses `outlines` to ensure the AI-generated data is structured and valid, conforming to Pydantic models.
- Merges metadata from different sources into a single, comprehensive output.
- Uses Apache Tika for robust EPUB content and metadata parsing.

## Project Structure

```
.
├── dataset/              # Sample EPUB files and publisher metadata
│   ├── metadata.csv
│   └── pg1342.epub
├── src/
│   ├── agent/            # AI model interactions
│   │   └── librarian.py
│   ├── models/           # Pydantic models for data structure
│   │   └── book.py
│   ├── task/             # Orchestration of the overall workflow
│   │   └── process_book.py
│   └── tool/             # Data processing utilities
│       ├── csv_parser.py
│       └── epub.py
├── .env                  # Environment variables (e.g., API keys)
├── main.py               # Main application script
├── pyproject.toml        # Project dependencies and metadata
└── README.md             # This file
```

## How It Works

1.  **Publisher Metadata**: The `read_publisher_metadata` function in `src/tool/csv_parser.py` reads known book metadata from `dataset/metadata.csv`.
2.  **EPUB Parsing**: The script uses `tika` to parse the specified EPUB file, extracting its text content and any embedded metadata (like `dc:title`).
3.  **AI Content Analysis**: The extracted text content is sent to the Gemini API via the `LibrarianAgent`. A detailed prompt guides the model to perform a literary analysis.
4.  **Structured Output**: The `outlines` library is used to constrain the AI's output, ensuring it returns a valid JSON object that matches the `ContentInformation` Pydantic model.
5.  **Data Consolidation**: The `process_book` task intelligently merges the metadata from the publisher's CSV, the EPUB's internal metadata, and the AI-generated analysis into a final `BookMetadata` object.
6.  **Output**: The final, consolidated metadata object is printed to the console as a formatted JSON string.

## Setup and Installation

### Prerequisites

- Python 3.12+
- Java (required by Apache Tika)

### Installation

1.  **Clone the repository:**
    ```sh
    git clone <repository-url>
    cd epub-metadata-extractor
    ```

2.  **Create a virtual environment and install dependencies:**
    This project uses `pip` for package management.
    ```sh
    python -m venv .venv
    source .venv/bin/activate
    pip install .
    ```

3.  **Set up environment variables:**
    Create a `.env` file in the project root and add your Google Gemini API key.
    ```
    GEMINI_API_KEY="YOUR_API_KEY_HERE"
    ```

## Usage

To run the extractor, execute the main script:

```sh
python main.py
```

By default, the script processes the file `./dataset/pg74.epub` and uses `./dataset/metadata.csv` for publisher information. You can modify the file paths in `main.py` to point to a different EPUB file.

### Example Output

The script will print a JSON object to the standard output, similar to this:

```json
{
    "title": "The Adventures of Tom Sawyer",
    "author": "Mark Twain",
    "publishing_year": 1876,
    "epub_id": "pg74",
    "genre": "Adventure",
    "themes": [
        "Friendship",
        "Morality",
        "Childhood",
        "Adventure",
        "Social satire"
    ],
    "setting": {
        "time": "1840s",
        "place": "The fictional town of St. Petersburg, Missouri"
    },
    "cultural_context": "The novel is set in a small town on the Mississippi River before the Civil War, reflecting the social norms, superstitions, and dialects of the time.",
    "narrative_tone": "Humorous, satirical, and nostalgic, with a third-person omniscient narrator.",
    "author_writing_style": "Characterized by realism, vernacular language, and detailed descriptions of the setting.",
    "characters_and_relationships": [
        {
            "name": "Tom Sawyer",
            "relationship": "The mischievous protagonist."
        },
        {
            "name": "Huckleberry Finn",
            "relationship": "Tom's best friend and fellow adventurer."
        },
        {
            "name": "Becky Thatcher",
            "relationship": "Tom's love interest."
        }
    ]
}
```

## License

This project is licensed under the MIT License. See the [LICENSE](LICENSE) file for details.